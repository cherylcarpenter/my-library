// ===========================================
// My Library â€” Prisma Schema
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USER & AUTH (Multi-user ready)
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  image         String?
  role          UserRole  @default(USER)
  emailVerified DateTime?

  // Relations
  accounts  Account[]
  sessions  Session[]
  libraries Library[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum UserRole {
  USER
  ADMIN
}

// ============================================
// LIBRARY (Per-user book collections)
// ============================================

model Library {
  id       String  @id @default(cuid())
  name     String  @default("My Library")
  slug     String
  isPublic Boolean @default(true)

  // Owner
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  userBooks UserBook[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, slug])
}

// ============================================
// BOOKS (Shared catalog)
// ============================================

model Book {
  id    String @id @default(cuid())
  title String
  slug  String @unique

  // Identifiers
  isbn           String?
  isbn13         String?
  goodreadsId    String? @unique
  openLibraryKey String?

  // Metadata
  description             String? @db.Text
  coverUrl                String?
  pages                   Int?
  yearPublished           Int?
  originalPublicationYear Int?
  publisher               String?
  binding                 String?
  language                String? @default("english")
  averageRating           Float?

  // Series
  seriesId    String?
  series      Series? @relation(fields: [seriesId], references: [id])
  seriesOrder Float? // Float allows 1.5 for novellas, etc.

  // Relations
  authors   BookAuthor[]
  userBooks UserBook[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([seriesId])
  @@index([slug])
}

// ============================================
// USER-BOOK RELATIONSHIP (Personal data)
// ============================================

model UserBook {
  id String @id @default(cuid())

  // Relations
  libraryId String
  library   Library @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  bookId    String
  book      Book    @relation(fields: [bookId], references: [id], onDelete: Cascade)

  // Reading Status
  shelf     Shelf     @default(TO_READ)
  dateRead  DateTime?
  dateAdded DateTime  @default(now())
  readCount Int       @default(0)

  // Personal Rating & Review
  myRating     Int?    // 1-5
  myReview     String? @db.Text
  privateNotes String? @db.Text

  // Ownership
  ownedKindle      Boolean  @default(false)
  ownedAudible     Boolean  @default(false)
  kindleAsin       String?
  audibleAsin      String?
  audibleDuration  String?
  audibleNarrators String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([libraryId, bookId])
  @@index([shelf])
  @@index([myRating])
  @@index([dateRead])
  @@index([dateAdded])
}

// ============================================
// SERIES
// ============================================

model Series {
  id             String  @id @default(cuid())
  name           String
  slug           String  @unique
  description    String? @db.Text
  openLibraryKey String?

  // Relations
  books Book[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// AUTHORS
// ============================================

model Author {
  id             String  @id @default(cuid())
  name           String
  slug           String  @unique
  openLibraryKey String?
  bio            String? @db.Text
  photoUrl       String?
  birthDate      String?
  deathDate      String?

  books BookAuthor[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BookAuthor {
  book     Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)
  bookId   String
  author   Author @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId String
  role     String @default("author") // author, narrator, editor

  @@id([bookId, authorId, role])
}

// ============================================
// ENUMS
// ============================================

enum Shelf {
  READ
  CURRENTLY_READING
  TO_READ
  TO_READ_SOONER
  DID_NOT_FINISH
}
